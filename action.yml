name: 'Security Action'
description: 'Collect and Generalize multiple CI Security checks'
inputs:
# in-name:
#   description: yadda yadda
#   required: true
#   default: 0
  github_token:
    description: |
      Secret token to push review comments, and
      interact with the repository systematically
    required: true
  slack_token:
    description: |
      Secret token to forward findings to slack
    required: false
  assignees:
    description: assign PR to the people linked
    default: |
      thypon
      bcaller
  debug:
    description: enables debug output for this action
    required: false
  codeql_config:
    description: CodeQL configuration config config
    default: ./.github/codeql/codeql-config.yml
# outputs:
#   out-name:
#     description: yadda yadda
#     value: ${{ steps.output-step-id.outputs.output-name }}
runs:
  using: 'composite'
  steps:
    - name: Setup Ruby
      id: ruby
      uses: ruby/setup-ruby@ee2113536afb7f793eed4ce60e8d3b26db912da4
      with:
        ruby-version: '2.7'

    - name: Setup Brakeman
      id: setup-brakeman
      shell: bash
      env:
        BRAKEMAN_VERSION: '5.4.0'
      run: |
        gem install brakeman --version $BRAKEMAN_VERSION

    - name: Brakeman
      id: brakeman
      shell: bash
      continue-on-error: true
      run: |
        set -xe
        mkdir -p ../sarifs
        brakeman -o ../sarifs/brakeman.sarif --force ./

    - name: Setup Semgrep
      id: setup-semgrep
      shell: bash
      run: |
        python3 -m pip install --disable-pip-version-check semgrep~=1.5.0

    - name: Semgrep
      id: semgrep
      shell: bash
      continue-on-error: true
      run: |
        set -ex
        mkdir -p ../sarifs
        semgrep \
          -c p/ci \
          -c p/security-audit \
          -c p/xss \
          -c p/nginx \
          -c p/docker \
          -c p/terraform \
          -c p/secrets \
          $(find $SCRIPTPATH/semgrep_rules -name '*.yml' -or -name '*.yaml' | sed 's/^/-c /g') \
          --metrics=off \
          --baseline-commit origin/${GITHUB_BASE_REF:-main} \
          --sarif \
          --output ../sarifs/semgrep.sarif
        # TODO: filter warnings
        
    - name: Upload SARIF
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: ../sarifs